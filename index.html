<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Авто-скриншот Игоря</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
            text-align: center;
        }
        
        .container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 20px auto;
        }
        
        #inputVideo {
            width: 100%;
            border-radius: 8px;
            transform: scaleX(-1);
            display: none; /* Скрываем видео, оставляем только канвас */
        }
        
        #canvasOutput {
            width: 100%;
            border-radius: 8px;
            background-color: #000;
        }
        
        #status {
            margin: 10px 0;
            font-weight: bold;
            min-height: 24px;
            padding: 10px;
            background-color: #fff;
            border-radius: 4px;
            width: 80%;
            max-width: 400px;
        }
        
        .screenshot-animation {
            animation: flash 0.3s;
        }
        
        @keyframes flash {
            0% { box-shadow: 0 0 0 0 rgba(0,0,0,0); }
            50% { box-shadow: 0 0 0 1000px rgba(255,255,255,0.8); }
            100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); }
        }
    </style>
</head>
<body>
    <h1>Авто-скриншот Игоря</h1>
    <p>Сожмите руку в кулак для создания скриншота</p>
    
    <div class="container">
        <video id="inputVideo" autoplay playsinline></video>
        <canvas id="canvasOutput"></canvas>
    </div>
    
    <div id="status">Запуск камеры...</div>

    <script>
        // DOM элементы
        const videoElement = document.getElementById('inputVideo');
        const canvasElement = document.getElementById('canvasOutput');
        const canvasCtx = canvasElement.getContext('2d');
        const statusElement = document.getElementById('status');
        
        // Переменные
        let hands = null;
        let isFistDetectedPrev = false;
        let lastFistTime = 0;
        const FIST_COOLDOWN = 1000; // Задержка между скриншотами (1 секунда)
        
        // Инициализация MediaPipe Hands
        function setupHandDetection() {
            hands = new Hands({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }
            });
            
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.6,
                minTrackingConfidence: 0.5
            });
            
            hands.onResults(onResults);
            
            // Запуск камеры
            const camera = new Camera(videoElement, {
                onFrame: async () => {
                    if (hands) {
                        await hands.send({image: videoElement});
                    }
                },
                width: 640,
                height: 480
            });
            
            camera.start().then(() => {
                statusElement.textContent = "Камера готова. Покажите руку камере.";
            });
        }
        
        // Проверка жеста "кулак"
        function checkFistGesture(landmarks) {
            if (!landmarks || landmarks.length < 20) return false;
            
            // Точки кончиков пальцев
            const thumbTip = landmarks[4];
            const indexTip = landmarks[8];
            const middleTip = landmarks[12];
            const ringTip = landmarks[16];
            const pinkyTip = landmarks[20];
            
            // Точки оснований пальцев
            const indexBase = landmarks[5];
            const middleBase = landmarks[9];
            const ringBase = landmarks[13];
            const pinkyBase = landmarks[17];
            
            // Проверяем, что все пальцы согнуты
            const isThumbClosed = thumbTip.y > landmarks[2].y;
            const isIndexClosed = indexTip.y > indexBase.y;
            const isMiddleClosed = middleTip.y > middleBase.y;
            const isRingClosed = ringTip.y > ringBase.y;
            const isPinkyClosed = pinkyTip.y > pinkyBase.y;
            
            return isThumbClosed && isIndexClosed && isMiddleClosed && isRingClosed && isPinkyClosed;
        }
        
        // Обработка результатов распознавания
        function onResults(results) {
            // Очищаем канвас
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            // Рисуем изображение с камеры
            canvasCtx.drawImage(
                results.image, 0, 0, canvasElement.width, canvasElement.height);
            
            if (results.multiHandLandmarks) {
                let isFistDetected = false;
                
                for (const landmarks of results.multiHandLandmarks) {
                    // Рисуем соединения и точки руки
                    drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, 
                                 {color: '#00FF00', lineWidth: 2});
                    drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 1});
                    
                    // Проверяем жест кулака
                    if (checkFistGesture(landmarks)) {
                        isFistDetected = true;
                    }
                }
                
                // Если обнаружен кулак и не в режиме кулдауна
                if (isFistDetected && !isFistDetectedPrev && (Date.now() - lastFistTime) > FIST_COOLDOWN) {
                    takeScreenshot();
                    lastFistTime = Date.now();
                }
                isFistDetectedPrev = isFistDetected;
            }
            canvasCtx.restore();
        }
        
        // Создание и сохранение скриншота
        function takeScreenshot() {
            // Анимация вспышки
            document.body.classList.add('screenshot-animation');
            setTimeout(() => {
                document.body.classList.remove('screenshot-animation');
            }, 300);
            
            // Создаем временный канвас
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = videoElement.videoWidth;
            tempCanvas.height = videoElement.videoHeight;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Копируем изображение с камеры (зеркальное отражение)
            tempCtx.save();
            tempCtx.scale(-1, 1);
            tempCtx.drawImage(videoElement, 0, 0, -tempCanvas.width, tempCanvas.height);
            tempCtx.restore();
            
            // Создаем ссылку для скачивания
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            link.download = `screenshot-${timestamp}.png`;
            link.href = tempCanvas.toDataURL('image/png');
            
            // Автоматическое скачивание
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Обновляем статус
            statusElement.textContent = `Скриншот сохранен (${new Date().toLocaleTimeString()})`;
        }
        
        // Устанавливаем размеры канваса
        function onResize() {
            if (videoElement.videoWidth) {
                const aspectRatio = videoElement.videoHeight / videoElement.videoWidth;
                const maxWidth = Math.min(640, window.innerWidth - 40);
                canvasElement.width = maxWidth;
                canvasElement.height = maxWidth * aspectRatio;
            }
        }
        
        // Обработчики событий
        window.addEventListener('resize', onResize);
        window.addEventListener('load', () => {
            setupHandDetection();
            // Периодически проверяем готовность видео
            const checkVideo = setInterval(() => {
                if (videoElement.videoWidth > 0) {
                    onResize();
                    clearInterval(checkVideo);
                }
            }, 100);
        });
    </script>
</body>
</html>
